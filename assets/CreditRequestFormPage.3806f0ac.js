import{Q as W}from"./QToolbarTitle.c5038441.js";import{k as A,g as $,B as H,o as j,i as X,n as t,w as l,s as n,t as c,a5 as Q,p as m,bf as I,_ as Y,u as Z,a as ee,l as te,$ as le,R as F,H as U,m as ae,Q as M,q as T,aU as re,a9 as ie,bi as oe,aR as B}from"./index.fb7f185a.js";import{Q as k}from"./QSpace.2eba6162.js";import{b as w,a as D}from"./QList.26d4ea01.js";import{Q as ue}from"./QToolbar.1a88aaf8.js";import{Q as se}from"./QHeader.101d03bb.js";import{b as g,Q as R,a as q}from"./use-form.9d7bef12.js";import{Q as P}from"./QChip.51b2b1ca.js";import{Q as N}from"./QInput.f91b8724.js";import{Q as ne}from"./QSelect.4e287e76.js";import{Q as de}from"./QFile.61351045.js";import{Q as ce}from"./QPage.10afa0e7.js";import{Q as me,a as fe}from"./QLayout.5b8a1d64.js";import{d as pe,b as ve,c as f}from"./QTable.651180d7.js";import"./QSeparator.2e777e02.js";import"./use-checkbox.23dfdacf.js";import"./option-sizes.54472383.js";import"./use-fullscreen.155c094a.js";const ge={class:"row"},be=A({__name:"OrderLinesCreditTable",setup(z){const p=$(),v=s=>{const _=Number(s.creditQty)>0?Number(s.creditQty):0,r=Number(s.unitPrice)||0,e=Number(s.cancellationFeePct)||0,y=_*r*(1-e/100);return I(y)},d=s=>{const _=Number(s.creditQty)>0?Number(s.creditQty):0,r=Number(s.unitPrice)||0,e=Number(s.cancellationFeePct)||0,y=_*r*(e/100);return I(y)},C=H(()=>p.order.dataLines),b=[{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(s,_)=>(j(),X("div",ge,[t(pe,{rows:C.value,columns:b,"rows-per-page-options":[0],"row-key":"dataLineId","filter-method":(r,e,y,x)=>r.filter(a=>a.isSelected),"virtual-scroll":"","hide-pagination":"",dense:"",class:"header-table",style:{height:"40vh",overflow:"auto",margin:"0.4rem"}},{body:l(r=>[t(ve,{props:r},{default:l(()=>[t(f,{key:"venueObs",props:r},{default:l(()=>[t(w,null,{default:l(()=>[n(c(r.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),t(f,{key:"service",props:r},{default:l(()=>[Q("div",null,[t(P,{dense:"","text-color":"white",color:"cyan",label:r.row.service},null,8,["label"])]),Q("div",null,c(r.row.description),1)]),_:2},1032,["props"]),t(f,{key:"quantity",props:r},{default:l(()=>[n(c(r.row.quantity),1)]),_:2},1032,["props"]),t(f,{key:"unitPrice",props:r},{default:l(()=>[n(c(m(I)(r.row.unitPrice)),1)]),_:2},1032,["props"]),t(f,{key:"total",props:r},{default:l(()=>[n(c(m(I)(r.row.total)),1)]),_:2},1032,["props"]),t(f,{key:"creditQty",props:r},{default:l(()=>[t(N,{modelValue:r.row.creditQty,"onUpdate:modelValue":e=>r.row.creditQty=e,modelModifiers:{number:!0},type:"number",dense:"","item-aligned":"","input-class":"text-right",rules:[e=>e<=r.row.quantity||"<= Qty"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),t(f,{key:"cancellationFeePct",props:r},{default:l(()=>[t(N,{modelValue:r.row.cancellationFeePct,"onUpdate:modelValue":e=>r.row.cancellationFeePct=e,modelModifiers:{number:!0},type:"number",rules:[e=>e<=100],"item-aligned":"",dense:"","input-class":"text-right",suffix:"%",style:{"min-width":"4rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"]),t(g,{caption:""},{default:l(()=>[n(c(d(r.row)),1)]),_:2},1024)]),_:2},1032,["props"]),t(f,{key:"creditSubtotal",props:r},{default:l(()=>[n(c(v(r.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","filter-method"])]))}});const _e={class:"row items-center"},ye={class:"text-h6"},Re={class:"ellipsis"},qe=A({__name:"CreditRequestFormPage",setup(z){const p=Z(),v=ee(),d=$(),C=te();le(()=>{p.readSettings(),v.readAllUsers();const a=C.query.orderId;typeof a=="string"&&d.readOrder(a)});const b=F(),s=F();async function _(a){s.value&&URL.revokeObjectURL(s.value),s.value=URL.createObjectURL(a);const u=await oe(s.value);e.value.file&&b.value&&(e.value.file.base64=u,e.value.file.name=b.value.name)}const r=H(()=>{var a;return!((a=d.order.dataLines)!=null&&a.length)||!e.value.userRecipient.userId}),e=F({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});U(()=>v.userDeptHeads,a=>{a.length>0&&(e.value.userRecipient.userId=a[0].userId,e.value.userRecipient.fullName=a[0].fullName,e.value.userRecipient.groupId=a[0].groupId,e.value.userRecipient.notifications=a[0].notifications)},{immediate:!0}),U(()=>p.loggedUser,a=>{a&&(e.value.userRequester.userId=a.userId,e.value.userRequester.fullName=a.fullName,e.value.userRequester.groupId=a.groupId,e.value.userRequester.notifications=a.notifications)},{immediate:!0}),U(()=>d.order,a=>{Object.keys(a).length>0&&(e.value.orderId=a.orderId,e.value.date=a.date,e.value.customerRequester=a.requester,e.value.customerRecipient=a.recipient)},{immediate:!0});const y=()=>{B("ORD | Request Credit Note Actions",{Parameter:"Cancel Request"})},x=()=>{e.value.orderLines=d.order.dataLines||[],console.log("orderLines",e.value.orderLines);const a=e.value.orderLines.length===1?"Service ":"Services ",u=e.value.orderLines.map(o=>o.service).join(", "),i=e.value.requestMessage?" \u2022 "+e.value.requestMessage:"",h={action:"Request Credit Note",description:"Requested "+e.value.userRecipient.fullName+" to credit the following "+a+u+" from the Order "+e.value.orderId+i},O=e.value.orderLines.map(o=>({dataLineId:o.dataLineId,venue:o.venueObs,service:o.service,description:o.description,quantity:o.quantity,total:o.total,unitPrice:o.unitPrice,creditQty:o.creditQty,cancellationFeePct:o.cancellationFeePct,cancellationFeeAmount:o.creditQty*o.unitPrice*(o.cancellationFeePct/100),creditTotal:o.creditQty*o.unitPrice*(1-o.cancellationFeePct/100)}));let L={...d.order};delete L.dataLines;const E="Requested "+e.value.userRecipient.fullName+" to credit the following "+a+"<strong>"+u+"</strong> from the Order <strong>"+e.value.orderId+"</strong> requested by <strong>"+e.value.customerRequester+"</strong> for <strong>"+e.value.customerRecipient+"</strong>"+i,G=e.value.userRequester.fullName+" has requested to credit the following "+a+"<strong>"+u+"</strong> from the Order <strong>"+e.value.orderId+"</strong> requested by <strong>"+e.value.customerRequester+"</strong> for <strong>"+e.value.customerRecipient+"</strong>"+i;console.log(O);const S={order:L,orderLines:O};e.value.orderLines=d.order.dataLines?d.order.dataLines.map((o,K)=>({...o,metadata:S.orderLines[K]})):[],v.createNotification(e.value.userRequester.notifications,{title:"Request Credit Note",recipientId:p.loggedUser.userId||"",content:E,type:"info",metadata:S}),v.createNotification(e.value.userRecipient.notifications,{title:"Request Credit Note",recipientId:e.value.userRecipient.userId,content:G,type:"task",metadata:S});let V="";e.value.file&&e.value.file.base64&&(V=e.value.file.base64.replace(/^data:.*;base64,/,""));const J={...e.value,userRecipient:e.value.userRecipient,userRequester:e.value.userRequester,file:{...e.value.file,base64:V},activity:h};B("ORD | Request Credit Note Actions",{Parameter:"Submit Request",Data:J})};return(a,u)=>(j(),ae(me,{view:"hHh lpR fFf"},{default:l(()=>[t(se,null,{default:l(()=>[t(ue,{class:"bg-primary"},{default:l(()=>[t(W,null,{default:l(()=>[n(" Credit Request ")]),_:1}),t(D,null,{default:l(()=>[t(M,{color:"primary",type:"cancel",label:"Cancel",onClick:u[0]||(u[0]=i=>y())}),t(k),t(M,{color:"primary",type:"submit",label:"Submit Request",onClick:u[1]||(u[1]=i=>x()),disable:r.value},null,8,["disable"])]),_:1})]),_:1})]),_:1}),t(fe,null,{default:l(()=>[t(ce,null,{default:l(()=>[t(R,null,{default:l(()=>[t(q,{horizontal:"",class:"items-center"},{default:l(()=>[t(g,{header:""},{default:l(()=>{var i;return[n(c((i=m(d).order)==null?void 0:i.orderId),1)]}),_:1}),t(k),t(g,{header:""},{default:l(()=>{var i;return[n(c((i=m(d).order)==null?void 0:i.date),1)]}),_:1}),t(k),t(q,null,{default:l(()=>{var i,h;return[t(P,{color:"blue-5","text-color":"white",label:`Requester: ${(i=m(d).order)==null?void 0:i.requester}`},null,8,["label"]),t(P,{color:"blue-5","text-color":"white",label:`Recipient: ${(h=m(d).order)==null?void 0:h.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),Q("div",_e,[t(R,null,{default:l(()=>[t(q,null,{default:l(()=>[t(g,null,{default:l(()=>[n("Requester")]),_:1}),t(N,{modelValue:m(p).loggedUser.fullName,"onUpdate:modelValue":u[2]||(u[2]=i=>m(p).loggedUser.fullName=i),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),t(R,null,{default:l(()=>[t(q,null,{default:l(()=>[t(g,null,{default:l(()=>[n("Request to")]),_:1}),t(ne,{modelValue:e.value.userRecipient,"onUpdate:modelValue":u[3]||(u[3]=i=>e.value.userRecipient=i),options:m(v).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:l(i=>[t(D,null,{default:l(()=>[t(w,{avatar:""},{default:l(()=>[t(T,{size:"sm","text-color":"white",style:re({backgroundColor:i.opt.color})},{default:l(()=>[n(c(i.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),t(w,null,{default:l(()=>[Q("span",ye,c(i.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),t(R,null,{default:l(()=>[t(q,null,{default:l(()=>[t(g,null,{default:l(()=>[n("Attachment")]),_:1}),t(de,{modelValue:b.value,"onUpdate:modelValue":[u[4]||(u[4]=i=>b.value=i),_],label:"Select File",outlined:"",clearable:"",dense:""},{file:l(({file:i})=>[t(P,{size:"sm",color:"primary text-white"},{default:l(()=>[t(T,null,{default:l(()=>[t(ie,{name:"sym_o_description"})]),_:1}),Q("div",Re,c(i.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),t(R,null,{default:l(()=>[t(q,null,{default:l(()=>[t(g,null,{default:l(()=>[n("Request Message")]),_:1}),t(N,{modelValue:e.value.requestMessage,"onUpdate:modelValue":u[5]||(u[5]=i=>e.value.requestMessage=i),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),t(R,null,{default:l(()=>[t(be)]),_:1})]),_:1})]),_:1})]),_:1}))}});var Ae=Y(qe,[["__scopeId","data-v-602c3700"]]);export{Ae as default};
