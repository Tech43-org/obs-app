import{Q as W}from"./QToolbarTitle.66ac37f5.js";import{i as B,f as $,z as A,o as j,X as Y,l as e,w as a,p as d,t as c,a5 as Q,m as f,bf as U,_ as z,u as Z,a as ee,j as te,$ as ae,O as F,F as k,k as le,Q as V,n as M,aU as re,a9 as se,bi as ie,aR as D}from"./index.18e7b13f.js";import{Q as w}from"./QSpace.01a593f3.js";import{a as I,Q as O}from"./QItem.e97e7b2d.js";import{Q as ue}from"./QToolbar.b96e205f.js";import{Q as oe}from"./QHeader.bab0505c.js";import{Q as b,a as y,b as R}from"./use-form.2e4f209f.js";import{Q as h}from"./QChip.a51c313e.js";import{Q as C}from"./QInput.6855e887.js";import{Q as ne}from"./QSelect.a339a826.js";import{Q as de}from"./QFile.3a8cdb71.js";import{Q as ce}from"./QPage.5fe767ee.js";import{Q as me,a as fe}from"./QLayout.1e10a2d9.js";import{d as pe,b as ve,c as p}from"./QTable.79f42dd4.js";import"./QSeparator.29ca5046.js";import"./QList.77eebc8e.js";import"./use-checkbox.08b445c4.js";import"./option-sizes.0fe0ec6c.js";import"./use-fullscreen.14c180a0.js";const _e={class:"row"},ge=B({__name:"OrderLinesCreditTable",setup(H){const v=$(),_=m=>{const g=Number(m.creditQty)>0?Number(m.creditQty):0,s=Number(m.unitPrice)||0,n=Number(m.cancellationFeePct)||0,t=g*s*(1-n/100);return U(t)},o=A(()=>v.order.dataLines),P=[{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(m,g)=>(j(),Y("div",_e,[e(pe,{rows:o.value,columns:P,"rows-per-page-options":[0],"row-key":"dataLineId","filter-method":(s,n,t,x)=>s.filter(S=>S.isSelected),"virtual-scroll":"","hide-pagination":"",dense:"",class:"header-table",style:{height:"40vh",overflow:"auto",margin:"0.4rem"}},{body:a(s=>[e(ve,{props:s},{default:a(()=>[e(p,{key:"venueObs",props:s},{default:a(()=>[e(I,null,{default:a(()=>[d(c(s.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"service",props:s},{default:a(()=>[e(O,{class:"q-ma-none q-pa-none items-center"},{default:a(()=>[e(h,{dense:"","text-color":"white",color:"cyan",label:s.row.service},null,8,["label"]),e(I,{side:""},{default:a(()=>[Q("span",null,c(s.row.description),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"quantity",props:s},{default:a(()=>[d(c(s.row.quantity),1)]),_:2},1032,["props"]),e(p,{key:"unitPrice",props:s},{default:a(()=>[d(c(f(U)(s.row.unitPrice)),1)]),_:2},1032,["props"]),e(p,{key:"total",props:s},{default:a(()=>[d(c(f(U)(s.row.total)),1)]),_:2},1032,["props"]),e(p,{key:"creditQty",props:s},{default:a(()=>[e(C,{modelValue:s.row.creditQty,"onUpdate:modelValue":n=>s.row.creditQty=n,modelModifiers:{number:!0},type:"number",rules:[n=>n>0&&n<=s.row.quantity],dense:"",standout:"","item-aligned":"","input-class":"text-right",style:{"min-width":"8rem"}},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"cancellationFeePct",props:s},{default:a(()=>[e(C,{modelValue:s.row.cancellationFeePct,"onUpdate:modelValue":n=>s.row.cancellationFeePct=n,modelModifiers:{number:!0},type:"number",rules:[n=>n<=100],"item-aligned":"",dense:"",standout:"","input-class":"text-right",suffix:"%",style:{"min-width":"5rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"creditSubtotal",props:s},{default:a(()=>[d(c(_(s.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","filter-method"])]))}});var be=z(ge,[["__scopeId","data-v-317c4d8c"]]);const ye={class:"row items-center"},Re={class:"text-h6"},qe={class:"ellipsis"},Qe=B({__name:"CreditRequestFormPage",setup(H){const v=Z(),_=ee(),o=$(),P=te();ae(()=>{v.readSettings(),_.readAllUsers();const l=P.query.orderId;typeof l=="string"&&o.readOrder(l)});const m=F(),g=F();async function s(l){g.value&&URL.revokeObjectURL(g.value),g.value=URL.createObjectURL(l);const u=await ie(g.value);t.value.file&&m.value&&(t.value.file.base64=u,t.value.file.name=m.value.name)}const n=A(()=>{var l;return!((l=o.order.dataLines)!=null&&l.length)||!t.value.userRecipient.userId}),t=F({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});k(()=>_.userDeptHeads,l=>{l.length>0&&(t.value.userRecipient.userId=l[0].userId,t.value.userRecipient.fullName=l[0].fullName,t.value.userRecipient.groupId=l[0].groupId,t.value.userRecipient.notifications=l[0].notifications)},{immediate:!0}),k(()=>v.loggedUser,l=>{l&&(t.value.userRequester.userId=l.userId,t.value.userRequester.fullName=l.fullName,t.value.userRequester.groupId=l.groupId,t.value.userRequester.notifications=l.notifications)},{immediate:!0}),k(()=>o.order,l=>{Object.keys(l).length>0&&(t.value.orderId=l.orderId,t.value.date=l.date,t.value.customerRequester=l.requester,t.value.customerRecipient=l.recipient)},{immediate:!0});const x=()=>{D("ORD | Request Credit Note Actions",{Parameter:"Cancel Request"})},S=()=>{t.value.orderLines=o.order.dataLines||[];const l=t.value.orderLines.length===1?"Service ":"Services ",u=t.value.orderLines.map(i=>i.service).join(", "),r=t.value.requestMessage?" \u2022 "+t.value.requestMessage:"",q={action:"Request Credit Note",description:"Requested "+t.value.userRecipient.fullName+" to credit the following "+l+u+" from the Order "+t.value.orderId+r},E=t.value.orderLines.map(i=>({dataLineId:i.dataLineId,venue:i.venueObs,service:i.service,description:i.description,quantity:i.quantity,total:i.total,unitPrice:i.unitPrice,creditQty:i.creditQty,cancellationFeePct:i.cancellationFeePct,cancellationFeeAmount:i.creditQty*i.unitPrice*(i.cancellationFeePct/100),creditTotal:i.creditQty*i.unitPrice*(1-i.cancellationFeePct/100)}));let L={...o.order};delete L.dataLines;const X="Requested "+t.value.userRecipient.fullName+" to credit the following "+l+"<strong>"+u+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+r,G=t.value.userRequester.fullName+" has requested to credit the following "+l+"<strong>"+u+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+r,N={order:L,orderLines:E};t.value.orderLines=o.order.dataLines?o.order.dataLines.map((i,K)=>({...i,metadata:N.orderLines[K]})):[],_.createNotification(t.value.userRequester.notifications,{title:"Request Credit Note",recipientId:v.loggedUser.userId||"",content:X,type:"info",metadata:N}),_.createNotification(t.value.userRecipient.notifications,{title:"Request Credit Note",recipientId:t.value.userRecipient.userId,content:G,type:"task",metadata:N});let T="";t.value.file&&t.value.file.base64&&(T=t.value.file.base64.replace(/^data:.*;base64,/,""));const J={...t.value,userRecipient:t.value.userRecipient,userRequester:t.value.userRequester,file:{...t.value.file,base64:T},activity:q};D("ORD | Request Credit Note Actions",{Parameter:"Submit Request",Data:J})};return(l,u)=>(j(),le(me,{view:"hHh lpR fFf"},{default:a(()=>[e(oe,null,{default:a(()=>[e(ue,{class:"bg-primary"},{default:a(()=>[e(W,null,{default:a(()=>[d(" Credit Request ")]),_:1}),e(O,null,{default:a(()=>[e(V,{color:"primary",type:"cancel",label:"Cancel",onClick:u[0]||(u[0]=r=>x())}),e(w),e(V,{color:"primary",type:"submit",label:"Submit Request",onClick:u[1]||(u[1]=r=>S()),disable:n.value},null,8,["disable"])]),_:1})]),_:1})]),_:1}),e(fe,null,{default:a(()=>[e(ce,null,{default:a(()=>[e(b,null,{default:a(()=>[e(y,{horizontal:"",class:"items-center"},{default:a(()=>[e(R,{header:""},{default:a(()=>{var r;return[d(c((r=f(o).order)==null?void 0:r.orderId),1)]}),_:1}),e(w),e(R,{header:""},{default:a(()=>{var r;return[d(c((r=f(o).order)==null?void 0:r.date),1)]}),_:1}),e(w),e(y,null,{default:a(()=>{var r,q;return[e(h,{color:"blue-5","text-color":"white",label:`Requester: ${(r=f(o).order)==null?void 0:r.requester}`},null,8,["label"]),e(h,{color:"blue-5","text-color":"white",label:`Recipient: ${(q=f(o).order)==null?void 0:q.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),Q("div",ye,[e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Requester")]),_:1}),e(C,{modelValue:f(v).loggedUser.fullName,"onUpdate:modelValue":u[2]||(u[2]=r=>f(v).loggedUser.fullName=r),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Request to")]),_:1}),e(ne,{modelValue:t.value.userRecipient,"onUpdate:modelValue":u[3]||(u[3]=r=>t.value.userRecipient=r),options:f(_).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:a(r=>[e(O,null,{default:a(()=>[e(I,{avatar:""},{default:a(()=>[e(M,{size:"sm","text-color":"white",style:re({backgroundColor:r.opt.color})},{default:a(()=>[d(c(r.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),e(I,null,{default:a(()=>[Q("span",Re,c(r.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Attachment")]),_:1}),e(de,{modelValue:m.value,"onUpdate:modelValue":[u[4]||(u[4]=r=>m.value=r),s],label:"Select File",outlined:"",clearable:"",dense:""},{file:a(({file:r})=>[e(h,{size:"sm",color:"primary text-white"},{default:a(()=>[e(M,null,{default:a(()=>[e(se,{name:"sym_o_description"})]),_:1}),Q("div",qe,c(r.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Request Message")]),_:1}),e(C,{modelValue:t.value.requestMessage,"onUpdate:modelValue":u[5]||(u[5]=r=>t.value.requestMessage=r),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(be)]),_:1})]),_:1})]),_:1})]),_:1}))}});var je=z(Qe,[["__scopeId","data-v-4f90dfe6"]]);export{je as default};
