import{Q as X}from"./QToolbarTitle.e4dc3fb6.js";import{l as B,g as j,E as A,o as $,j as Y,s as e,w as a,x as d,y as c,a7 as Q,t as f,bg as U,_ as z,u as Z,a as ee,m as te,a1 as ae,r as F,L as w,q as le,Q as V,v as M,aV as re,ab as se,bj as ie,p as D}from"./index.019e11b5.js";import{Q as k}from"./QSpace.9f6a112b.js";import{a as I,Q as x}from"./QItem.44ad7d0f.js";import{Q as oe}from"./QToolbar.596401b5.js";import{Q as ue}from"./QHeader.9dd9d550.js";import{Q as b,a as y,b as R}from"./use-form.5d0e830d.js";import{Q as h}from"./QChip.67e150a2.js";import{Q as C}from"./QInput.bff96581.js";import{Q as ne}from"./QSelect.aa243a20.js";import{Q as de}from"./QFile.40f0311e.js";import{Q as ce}from"./QPage.8967ee87.js";import{Q as me,a as fe}from"./QLayout.4252664c.js";import{c as pe,a as ve,b as p}from"./QTable.4e7289ad.js";import"./uid.42677368.js";import"./QSeparator.4a9a2582.js";import"./QList.56f0181e.js";import"./QCheckbox.d9eaf75f.js";import"./use-checkbox.bdfc919e.js";import"./option-sizes.2b7e9541.js";import"./use-fullscreen.2be9100d.js";const ge={class:"row"},_e=B({__name:"OrderLinesCreditTable",setup(H){const v=j(),g=m=>{const _=Number(m.creditQty)>0?Number(m.creditQty):0,s=Number(m.unitPrice)||0,n=Number(m.cancellationFeePct)||0,t=_*s*(1-n/100);return U(t)},u=A(()=>v.order.dataLines),P=[{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(m,_)=>($(),Y("div",ge,[e(pe,{rows:u.value,columns:P,"rows-per-page-options":[0],"row-key":"dataLineId","filter-method":(s,n,t,O)=>s.filter(S=>S.isSelected),"virtual-scroll":"","hide-pagination":"",dense:"",class:"header-table",style:{height:"40vh",overflow:"auto",margin:"0.4rem"}},{body:a(s=>[e(ve,{props:s},{default:a(()=>[e(p,{key:"venueObs",props:s},{default:a(()=>[e(I,null,{default:a(()=>[d(c(s.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"service",props:s},{default:a(()=>[e(x,{class:"q-ma-none q-pa-none items-center"},{default:a(()=>[e(h,{dense:"","text-color":"white",color:"cyan",label:s.row.service},null,8,["label"]),e(I,{side:""},{default:a(()=>[Q("span",null,c(s.row.description),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"quantity",props:s},{default:a(()=>[d(c(s.row.quantity),1)]),_:2},1032,["props"]),e(p,{key:"unitPrice",props:s},{default:a(()=>[d(c(f(U)(s.row.unitPrice)),1)]),_:2},1032,["props"]),e(p,{key:"total",props:s},{default:a(()=>[d(c(f(U)(s.row.total)),1)]),_:2},1032,["props"]),e(p,{key:"creditQty",props:s},{default:a(()=>[e(C,{modelValue:s.row.creditQty,"onUpdate:modelValue":n=>s.row.creditQty=n,modelModifiers:{number:!0},type:"number",rules:[n=>n>0&&n<=s.row.quantity],dense:"",standout:"","item-aligned":"","input-class":"text-right",style:{"min-width":"5rem"}},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"cancellationFeePct",props:s},{default:a(()=>[e(C,{modelValue:s.row.cancellationFeePct,"onUpdate:modelValue":n=>s.row.cancellationFeePct=n,modelModifiers:{number:!0},type:"number",rules:[n=>n<=100],"item-aligned":"",dense:"",standout:"","input-class":"text-right",suffix:"%",style:{"min-width":"5rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"creditSubtotal",props:s},{default:a(()=>[d(c(g(s.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","filter-method"])]))}});var be=z(_e,[["__scopeId","data-v-c5d72c6e"]]);const ye={class:"row items-center"},Re={class:"text-h6"},qe={class:"ellipsis"},Qe=B({__name:"CreditRequestFormPage",setup(H){const v=Z(),g=ee(),u=j(),P=te();ae(()=>{v.readSettings(),g.readAllUsers();const l=P.query.orderId;typeof l=="string"&&u.readOrder(l)});const m=F(),_=F();async function s(l){_.value&&URL.revokeObjectURL(_.value),_.value=URL.createObjectURL(l);const o=await ie(_.value);t.value.file&&m.value&&(t.value.file.base64=o,t.value.file.name=m.value.name)}const n=A(()=>{var l;return!((l=u.order.dataLines)!=null&&l.length)||!t.value.userRecipient.userId}),t=F({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});w(()=>g.userDeptHeads,l=>{l.length>0&&(t.value.userRecipient.userId=l[0].userId,t.value.userRecipient.fullName=l[0].fullName,t.value.userRecipient.groupId=l[0].groupId,t.value.userRecipient.notifications=l[0].notifications)},{immediate:!0}),w(()=>v.loggedUser,l=>{l&&(t.value.userRequester.userId=l.userId,t.value.userRequester.fullName=l.fullName,t.value.userRequester.groupId=l.groupId,t.value.userRequester.notifications=l.notifications)},{immediate:!0}),w(()=>u.order,l=>{Object.keys(l).length>0&&(t.value.orderId=l.orderId,t.value.date=l.date,t.value.customerRequester=l.requester,t.value.customerRecipient=l.recipient)},{immediate:!0});const O=()=>{D("ORD | Request Credit Note Actions",{Parameter:"Cancel Request"})},S=()=>{t.value.orderLines=u.order.dataLines||[],console.log("orderLines",t.value.orderLines);const l=t.value.orderLines.length===1?"Service ":"Services ",o=t.value.orderLines.map(i=>i.service).join(", "),r=t.value.requestMessage?" \u2022 "+t.value.requestMessage:"",q={action:"Request Credit Note",description:"Requested "+t.value.userRecipient.fullName+" to credit the following "+l+o+" from the Order "+t.value.orderId+r},E=t.value.orderLines.map(i=>({dataLineId:i.dataLineId,venue:i.venueObs,service:i.service,description:i.description,quantity:i.quantity,total:i.total,unitPrice:i.unitPrice,creditQty:i.creditQty,cancellationFeePct:i.cancellationFeePct,cancellationFeeAmount:i.creditQty*i.unitPrice*(i.cancellationFeePct/100),creditTotal:i.creditQty*i.unitPrice*(1-i.cancellationFeePct/100)}));let L={...u.order};delete L.dataLines;const G="Requested "+t.value.userRecipient.fullName+" to credit the following "+l+"<strong>"+o+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+r,J=t.value.userRequester.fullName+" has requested to credit the following "+l+"<strong>"+o+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+r,N={order:L,orderLines:E};t.value.orderLines=u.order.dataLines?u.order.dataLines.map((i,W)=>({...i,metadata:N.orderLines[W]})):[],g.createNotification(t.value.userRequester.notifications,{title:"Request Credit Note",recipientId:v.loggedUser.userId||"",content:G,type:"info",metadata:N}),g.createNotification(t.value.userRecipient.notifications,{title:"Request Credit Note",recipientId:t.value.userRecipient.userId,content:J,type:"task",metadata:N});let T="";t.value.file&&t.value.file.base64&&(T=t.value.file.base64.replace(/^data:.*;base64,/,""));const K={...t.value,userRecipient:t.value.userRecipient,userRequester:t.value.userRequester,file:{...t.value.file,base64:T},activity:q};D("ORD | Request Credit Note Actions",{Parameter:"Submit Request",Data:K})};return(l,o)=>($(),le(me,{view:"hHh lpR fFf"},{default:a(()=>[e(ue,null,{default:a(()=>[e(oe,{class:"bg-primary"},{default:a(()=>[e(X,null,{default:a(()=>[d(" Credit Request ")]),_:1}),e(x,null,{default:a(()=>[e(V,{color:"primary",type:"cancel",label:"Cancel",onClick:o[0]||(o[0]=r=>O())}),e(k),e(V,{color:"primary",type:"submit",label:"Submit Request",onClick:o[1]||(o[1]=r=>S()),disable:n.value},null,8,["disable"])]),_:1})]),_:1})]),_:1}),e(fe,null,{default:a(()=>[e(ce,null,{default:a(()=>[e(b,null,{default:a(()=>[e(y,{horizontal:"",class:"items-center"},{default:a(()=>[e(R,{header:""},{default:a(()=>{var r;return[d(c((r=f(u).order)==null?void 0:r.orderId),1)]}),_:1}),e(k),e(R,{header:""},{default:a(()=>{var r;return[d(c((r=f(u).order)==null?void 0:r.date),1)]}),_:1}),e(k),e(y,null,{default:a(()=>{var r,q;return[e(h,{color:"blue-5","text-color":"white",label:`Requester: ${(r=f(u).order)==null?void 0:r.requester}`},null,8,["label"]),e(h,{color:"blue-5","text-color":"white",label:`Recipient: ${(q=f(u).order)==null?void 0:q.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),Q("div",ye,[e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Requester")]),_:1}),e(C,{modelValue:f(v).loggedUser.fullName,"onUpdate:modelValue":o[2]||(o[2]=r=>f(v).loggedUser.fullName=r),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Request to")]),_:1}),e(ne,{modelValue:t.value.userRecipient,"onUpdate:modelValue":o[3]||(o[3]=r=>t.value.userRecipient=r),options:f(g).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:a(r=>[e(x,null,{default:a(()=>[e(I,{avatar:""},{default:a(()=>[e(M,{size:"sm","text-color":"white",style:re({backgroundColor:r.opt.color})},{default:a(()=>[d(c(r.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),e(I,null,{default:a(()=>[Q("span",Re,c(r.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Attachment")]),_:1}),e(de,{modelValue:m.value,"onUpdate:modelValue":[o[4]||(o[4]=r=>m.value=r),s],label:"Select File",outlined:"",clearable:"",dense:""},{file:a(({file:r})=>[e(h,{size:"sm",color:"primary text-white"},{default:a(()=>[e(M,null,{default:a(()=>[e(se,{name:"sym_o_description"})]),_:1}),Q("div",qe,c(r.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),e(b,null,{default:a(()=>[e(y,null,{default:a(()=>[e(R,null,{default:a(()=>[d("Request Message")]),_:1}),e(C,{modelValue:t.value.requestMessage,"onUpdate:modelValue":o[5]||(o[5]=r=>t.value.requestMessage=r),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[e(be)]),_:1})]),_:1})]),_:1})]),_:1}))}});var He=z(Qe,[["__scopeId","data-v-1f0609e6"]]);export{He as default};
