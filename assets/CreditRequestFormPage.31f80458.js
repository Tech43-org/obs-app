import{Q as X}from"./QToolbarTitle.57db756d.js";import{Q as Y}from"./QToolbar.4b047536.js";import{Q as Z}from"./QHeader.6755a62c.js";import{b,Q as R,a as _}from"./use-form.aee44101.js";import{Q as C}from"./QSpace.d5aa16c5.js";import{Q as S}from"./QChip.37129d69.js";import{Q as N}from"./QInput.62713b3e.js";import{k as A,h as $,o as H,i as ee,n as e,w as l,p as m,aQ as te,s as n,t as d,a5 as h,bg as P,_ as le,u as ae,a as re,g as ie,l as se,$ as ue,R as w,B as oe,H as F,m as ne,q as V,aU as de,a9 as ce,Q as M,bh as me,aR as T,bi as D}from"./index.481c2d9a.js";import{b as k,a as L}from"./QList.813d9784.js";import{Q as fe}from"./QSelect.0f167acb.js";import{Q as pe,a as B}from"./QFile.cdadb7f8.js";import{Q as ve}from"./QPage.af9410ed.js";import{Q as ge,a as be}from"./QLayout.03322efe.js";import{d as Re,b as _e,c as p,Q as ye}from"./QTable.46be65af.js";import"./QSeparator.2dc8520c.js";import"./use-checkbox.26dcd2c7.js";import"./use-fullscreen.8c885a96.js";const qe={class:"row"},Qe=A({__name:"OrderLinesCreditTable",setup(j){const g=$(),y=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,o=Number(c.cancellationFeePct)||0,Q=f*a*(1-o/100);return P(Q)},v=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,o=Number(c.cancellationFeePct)||0,Q=f*a*(o/100);return P(Q)},q=[{name:"recipient",label:"Recipient",align:"left",field:"recipient"},{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(c,f)=>(H(),ee("div",qe,[e(Re,{rows:m(g).dataLines,columns:q,selected:m(g).selectedRows,"onUpdate:selected":f[0]||(f[0]=a=>m(g).selectedRows=a),"rows-per-page-options":[0],"row-key":"dataLineId",selection:"multiple","virtual-scroll":"","hide-pagination":"",dense:"",title:"Order Lines",class:"header-table",style:{height:"50vh",overflow:"auto",margin:"0.4rem"}},{body:l(a=>[e(_e,{props:a},{default:l(()=>[e(p,null,{default:l(()=>[e(ye,{modelValue:a.selected,"onUpdate:modelValue":o=>a.selected=o,color:"primary",onClick:te(o=>a.selected=!a.selected,["stop"])},null,8,["modelValue","onUpdate:modelValue","onClick"])]),_:2},1024),e(p,{key:"recipient",props:a},{default:l(()=>[n(d(a.row.recipient),1)]),_:2},1032,["props"]),e(p,{key:"venueObs",props:a},{default:l(()=>[e(k,null,{default:l(()=>[n(d(a.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"service",props:a},{default:l(()=>[h("div",null,[e(S,{dense:"","text-color":"white",color:"cyan",label:a.row.service},null,8,["label"])]),h("div",null,d(a.row.description),1)]),_:2},1032,["props"]),e(p,{key:"quantity",props:a},{default:l(()=>[n(d(a.row.quantity),1)]),_:2},1032,["props"]),e(p,{key:"unitPrice",props:a},{default:l(()=>[n(d(m(P)(a.row.unitPrice)),1)]),_:2},1032,["props"]),e(p,{key:"total",props:a},{default:l(()=>[n(d(m(P)(a.row.total)),1)]),_:2},1032,["props"]),e(p,{key:"creditQty",props:a},{default:l(()=>[e(N,{modelValue:a.row.creditQty,"onUpdate:modelValue":o=>a.row.creditQty=o,modelModifiers:{number:!0},type:"number",dense:"","item-aligned":"","input-class":"text-right",rules:[o=>o<=a.row.quantity||"<= Qty"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"cancellationFeePct",props:a},{default:l(()=>[e(N,{modelValue:a.row.cancellationFeePct,"onUpdate:modelValue":o=>a.row.cancellationFeePct=o,modelModifiers:{number:!0},type:"number",rules:[o=>o<=100],"item-aligned":"",dense:"","input-class":"text-right",suffix:"%",style:{"min-width":"4rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"]),e(b,{caption:""},{default:l(()=>[n(d(v(a.row)),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"creditSubtotal",props:a},{default:l(()=>[n(d(y(a.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","selected"])]))}});const he={class:"row items-center"},Ie={class:"text-h6"},Pe={class:"ellipsis"},Se=A({__name:"CreditRequestFormPage",setup(j){const g=ae(),y=re(),v=ie(),q=$(),c=se();ue(()=>{g.readSettings(),y.readAllUsers();const r=c.query.orderId;typeof r=="string"&&v.readOrder(r)});const f=w(),a=w();async function o(r){a.value&&URL.revokeObjectURL(a.value),a.value=URL.createObjectURL(r);const u=await me(a.value);t.value.file&&f.value&&(t.value.file.base64=u,t.value.file.name=f.value.name)}const Q=oe(()=>!q.selectedRows.length||!t.value.userRecipient.userId),t=w({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});F(()=>y.userDeptHeads,r=>{r.length>0&&(t.value.userRecipient.userId=r[0].userId,t.value.userRecipient.fullName=r[0].fullName,t.value.userRecipient.groupId=r[0].groupId,t.value.userRecipient.notifications=r[0].notifications)},{immediate:!0}),F(()=>g.loggedUser,r=>{r&&(t.value.userRequester.userId=r.userId,t.value.userRequester.fullName=r.fullName,t.value.userRequester.groupId=r.groupId,t.value.userRequester.notifications=r.notifications)},{immediate:!0}),F(()=>v.order,r=>{Object.keys(r).length>0&&(t.value.orderId=r.orderId,t.value.date=r.date,t.value.customerRequester=r.requester,t.value.customerRecipient=r.recipient)},{immediate:!0});const z=()=>{T("ORD | Request Credit Note Actions",{Parameter:"Cancel Request"})},E=()=>{t.value.orderLines=q.selectedRows;const r=t.value.orderLines.length===1?"Service ":"Services ",u=t.value.orderLines.map(s=>s.service).join(", "),i=t.value.requestMessage?" Reason: "+t.value.requestMessage:"",I="Requested "+t.value.userRecipient.fullName+" to credit the following "+r+u+" from the Order "+t.value.orderId+i,G="Requested "+t.value.userRecipient.fullName+" to credit the following "+r+"<strong>"+u+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+i;t.value.userRequester.notifications||(t.value.userRequester.notifications=[]),t.value.userRequester.notifications.push(D({title:"Request Credit Note",senderId:t.value.userRequester.userId||"",recipientId:t.value.userRecipient.userId,content:G,type:"info"}));const J=t.value.userRequester.fullName+" has requested to credit the following "+r+"<strong>"+u+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+i,U=t.value.orderLines.map(s=>({dataLineId:s.dataLineId,venue:s.venueObs,service:s.service,description:s.description,quantity:s.quantity,total:s.total,unitPrice:s.unitPrice,creditQty:s.creditQty,cancellationFeePct:s.cancellationFeePct,cancellationFeeAmount:s.creditQty*s.unitPrice*(s.cancellationFeePct/100),creditTotal:s.creditQty*s.unitPrice*(1-s.cancellationFeePct/100)}));t.value.orderLines=q.selectedRows.map((s,W)=>({...s,metadata:U[W]})),t.value.userRecipient.notifications||(t.value.userRecipient.notifications=[]);let x={...v.order};delete x.dataLines,t.value.userRecipient.notifications.push(D({title:"Request Credit Note",senderId:t.value.userRequester.userId||"",recipientId:t.value.userRecipient.userId,content:J,type:"task",metadata:U,order:x}));let O="";t.value.file&&t.value.file.base64&&(O=t.value.file.base64.replace(/^data:.*;base64,/,""));const K={...t.value,userRecipient:t.value.userRecipient,userRequester:t.value.userRequester,file:{...t.value.file,base64:O},activityDescription:I};T("ORD | Request Credit Note Actions",{Parameter:"Submit Request",Data:K})};return(r,u)=>(H(),ne(ge,{view:"hHh lpR fFf"},{default:l(()=>[e(Z,null,{default:l(()=>[e(Y,{class:"bg-primary"},{default:l(()=>[e(X,null,{default:l(()=>[n(" Credit Request Form ")]),_:1})]),_:1})]),_:1}),e(be,null,{default:l(()=>[e(ve,null,{default:l(()=>[e(R,null,{default:l(()=>[e(_,{horizontal:"",class:"items-center"},{default:l(()=>[e(b,{header:""},{default:l(()=>{var i;return[n(d((i=m(v).order)==null?void 0:i.orderId),1)]}),_:1}),e(C),e(b,{header:""},{default:l(()=>{var i;return[n(d((i=m(v).order)==null?void 0:i.date),1)]}),_:1}),e(C),e(_,null,{default:l(()=>{var i,I;return[e(S,{color:"blue-5","text-color":"white",label:`Requester: ${(i=m(v).order)==null?void 0:i.requester}`},null,8,["label"]),e(S,{color:"blue-5","text-color":"white",label:`Recipient: ${(I=m(v).order)==null?void 0:I.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),h("div",he,[e(R,null,{default:l(()=>[e(_,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Requester")]),_:1}),e(N,{modelValue:m(g).loggedUser.fullName,"onUpdate:modelValue":u[0]||(u[0]=i=>m(g).loggedUser.fullName=i),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(R,null,{default:l(()=>[e(_,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Request to")]),_:1}),e(fe,{modelValue:t.value.userRecipient,"onUpdate:modelValue":u[1]||(u[1]=i=>t.value.userRecipient=i),options:m(y).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:l(i=>[e(L,null,{default:l(()=>[e(k,{avatar:""},{default:l(()=>[e(V,{size:"sm","text-color":"white",style:de({backgroundColor:i.opt.color})},{default:l(()=>[n(d(i.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),e(k,null,{default:l(()=>[h("span",Ie,d(i.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),e(R,null,{default:l(()=>[e(_,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Attachment")]),_:1}),e(pe,{modelValue:f.value,"onUpdate:modelValue":[u[2]||(u[2]=i=>f.value=i),o],label:"Select File",outlined:"",clearable:"",dense:""},{file:l(({file:i})=>[e(S,{size:"sm",color:"primary text-white"},{default:l(()=>[e(V,null,{default:l(()=>[e(ce,{name:"sym_o_description"})]),_:1}),h("div",Pe,d(i.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),e(R,null,{default:l(()=>[e(_,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Request Message")]),_:1}),e(N,{modelValue:t.value.requestMessage,"onUpdate:modelValue":u[3]||(u[3]=i=>t.value.requestMessage=i),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(R,{style:{"min-height":"396px"}},{default:l(()=>[e(Qe)]),_:1})]),_:1})]),_:1}),e(B,{style:{"background-color":"var(--primary-white)"},class:"text-white"},{default:l(()=>[e(B,{style:{"background-color":"var(--primary-white)"},class:"text-white"},{default:l(()=>[e(L,null,{default:l(()=>[e(M,{color:"primary",type:"cancel",label:"Cancel",onClick:u[4]||(u[4]=i=>z())}),e(C),e(M,{color:"primary",type:"submit",label:"Submit Request",onClick:u[5]||(u[5]=i=>E()),disable:Q.value},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1}))}});var ze=le(Se,[["__scopeId","data-v-45a68d9c"]]);export{ze as default};
