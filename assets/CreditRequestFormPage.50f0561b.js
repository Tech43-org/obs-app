import{Q as W}from"./QToolbarTitle.0a5e79c9.js";import{k as D,h as B,o as A,i as X,n as e,w as l,p as m,aQ as Y,s as n,t as d,a5 as h,bf as P,_ as Z,u as ee,a as te,g as le,l as ae,$ as re,R as U,B as ie,H as F,m as ue,Q as V,q as M,aU as se,a9 as oe,bi as ne,aR as T}from"./index.64f1b3d0.js";import{Q as k}from"./QSpace.35a631cc.js";import{b as w,a as L}from"./QList.e8ca5dd3.js";import{Q as de}from"./QToolbar.ecf026c7.js";import{Q as ce}from"./QHeader.ef343378.js";import{b as _,Q as R,a as y}from"./use-form.5c69af30.js";import{Q as N}from"./QChip.4e46e48c.js";import{Q as S}from"./QInput.1a0ef85a.js";import{Q as me}from"./QSelect.5c3f0033.js";import{Q as fe}from"./QFile.2da25492.js";import{Q as pe}from"./QPage.6afafff0.js";import{Q as ve,a as ge}from"./QLayout.c38a26c9.js";import{d as be,b as _e,c as p,Q as Re}from"./QTable.a80fc28f.js";import"./QSeparator.0eab9167.js";import"./use-checkbox.9ce5a6c8.js";import"./option-sizes.abea4928.js";import"./use-fullscreen.aaf8ca42.js";const ye={class:"row"},qe=D({__name:"OrderLinesCreditTable",setup($){const v=B(),b=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,o=Number(c.cancellationFeePct)||0,Q=f*a*(1-o/100);return P(Q)},g=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,o=Number(c.cancellationFeePct)||0,Q=f*a*(o/100);return P(Q)},q=[{name:"recipient",label:"Recipient",align:"left",field:"recipient"},{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(c,f)=>(A(),X("div",ye,[e(be,{rows:m(v).dataLines,columns:q,selected:m(v).selectedRows,"onUpdate:selected":f[0]||(f[0]=a=>m(v).selectedRows=a),"rows-per-page-options":[0],"row-key":"dataLineId",selection:"multiple","virtual-scroll":"","hide-pagination":"",dense:"",class:"header-table",style:{height:"40vh",overflow:"auto",margin:"0.4rem"}},{body:l(a=>[e(_e,{props:a},{default:l(()=>[e(p,null,{default:l(()=>[e(Re,{modelValue:a.selected,"onUpdate:modelValue":o=>a.selected=o,color:"primary",onClick:Y(o=>a.selected=!a.selected,["stop"])},null,8,["modelValue","onUpdate:modelValue","onClick"])]),_:2},1024),e(p,{key:"recipient",props:a},{default:l(()=>[n(d(a.row.recipient),1)]),_:2},1032,["props"]),e(p,{key:"venueObs",props:a},{default:l(()=>[e(w,null,{default:l(()=>[n(d(a.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"service",props:a},{default:l(()=>[h("div",null,[e(N,{dense:"","text-color":"white",color:"cyan",label:a.row.service},null,8,["label"])]),h("div",null,d(a.row.description),1)]),_:2},1032,["props"]),e(p,{key:"quantity",props:a},{default:l(()=>[n(d(a.row.quantity),1)]),_:2},1032,["props"]),e(p,{key:"unitPrice",props:a},{default:l(()=>[n(d(m(P)(a.row.unitPrice)),1)]),_:2},1032,["props"]),e(p,{key:"total",props:a},{default:l(()=>[n(d(m(P)(a.row.total)),1)]),_:2},1032,["props"]),e(p,{key:"creditQty",props:a},{default:l(()=>[e(S,{modelValue:a.row.creditQty,"onUpdate:modelValue":o=>a.row.creditQty=o,modelModifiers:{number:!0},type:"number",dense:"","item-aligned":"","input-class":"text-right",rules:[o=>o<=a.row.quantity||"<= Qty"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"cancellationFeePct",props:a},{default:l(()=>[e(S,{modelValue:a.row.cancellationFeePct,"onUpdate:modelValue":o=>a.row.cancellationFeePct=o,modelModifiers:{number:!0},type:"number",rules:[o=>o<=100],"item-aligned":"",dense:"","input-class":"text-right",suffix:"%",style:{"min-width":"4rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"]),e(_,{caption:""},{default:l(()=>[n(d(g(a.row)),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"creditSubtotal",props:a},{default:l(()=>[n(d(b(a.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","selected"])]))}});const Qe={class:"row items-center"},he={class:"text-h6"},Ie={class:"ellipsis"},Pe=D({__name:"CreditRequestFormPage",setup($){const v=ee(),b=te(),g=le(),q=B(),c=ae();re(()=>{v.readSettings(),b.readAllUsers();const r=c.query.orderId;typeof r=="string"&&g.readOrder(r)});const f=U(),a=U();async function o(r){a.value&&URL.revokeObjectURL(a.value),a.value=URL.createObjectURL(r);const s=await ne(a.value);t.value.file&&f.value&&(t.value.file.base64=s,t.value.file.name=f.value.name)}const Q=ie(()=>!q.selectedRows.length||!t.value.userRecipient.userId),t=U({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});F(()=>b.userDeptHeads,r=>{r.length>0&&(t.value.userRecipient.userId=r[0].userId,t.value.userRecipient.fullName=r[0].fullName,t.value.userRecipient.groupId=r[0].groupId,t.value.userRecipient.notifications=r[0].notifications)},{immediate:!0}),F(()=>v.loggedUser,r=>{r&&(t.value.userRequester.userId=r.userId,t.value.userRequester.fullName=r.fullName,t.value.userRequester.groupId=r.groupId,t.value.userRequester.notifications=r.notifications)},{immediate:!0}),F(()=>g.order,r=>{Object.keys(r).length>0&&(t.value.orderId=r.orderId,t.value.date=r.date,t.value.customerRequester=r.requester,t.value.customerRecipient=r.recipient)},{immediate:!0});const H=()=>{T("ORD | Request Credit Note Actions",{Parameter:"Cancel Request"})},j=()=>{t.value.orderLines=q.selectedRows;const r=t.value.orderLines.length===1?"Service ":"Services ",s=t.value.orderLines.map(u=>u.service).join(", "),i=t.value.requestMessage?" \u2022 "+t.value.requestMessage:"",I={action:"Request Credit Note",description:"Requested "+t.value.userRecipient.fullName+" to credit the following "+r+s+" from the Order "+t.value.orderId+i},z=t.value.orderLines.map(u=>({dataLineId:u.dataLineId,venue:u.venueObs,service:u.service,description:u.description,quantity:u.quantity,total:u.total,unitPrice:u.unitPrice,creditQty:u.creditQty,cancellationFeePct:u.cancellationFeePct,cancellationFeeAmount:u.creditQty*u.unitPrice*(u.cancellationFeePct/100),creditTotal:u.creditQty*u.unitPrice*(1-u.cancellationFeePct/100)}));let x={...g.order};delete x.dataLines;const E="Requested "+t.value.userRecipient.fullName+" to credit the following "+r+"<strong>"+s+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+i,G=t.value.userRequester.fullName+" has requested to credit the following "+r+"<strong>"+s+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+i,C={order:x,orderLines:z};t.value.orderLines=q.selectedRows.map((u,K)=>({...u,metadata:C.orderLines[K]})),b.createNotification(t.value.userRequester.notifications,{title:"Request Credit Note",recipientId:v.loggedUser.userId||"",content:E,type:"info",metadata:C}),b.createNotification(t.value.userRecipient.notifications,{title:"Request Credit Note",recipientId:t.value.userRecipient.userId,content:G,type:"task",metadata:C});let O="";t.value.file&&t.value.file.base64&&(O=t.value.file.base64.replace(/^data:.*;base64,/,""));const J={...t.value,userRecipient:t.value.userRecipient,userRequester:t.value.userRequester,file:{...t.value.file,base64:O},activity:I};T("ORD | Request Credit Note Actions",{Parameter:"Submit Request",Data:J})};return(r,s)=>(A(),ue(ve,{view:"hHh lpR fFf"},{default:l(()=>[e(ce,null,{default:l(()=>[e(de,{class:"bg-primary"},{default:l(()=>[e(W,null,{default:l(()=>[n(" Credit Request ")]),_:1}),e(L,null,{default:l(()=>[e(V,{color:"primary",type:"cancel",label:"Cancel",onClick:s[0]||(s[0]=i=>H())}),e(k),e(V,{color:"primary",type:"submit",label:"Submit Request",onClick:s[1]||(s[1]=i=>j()),disable:Q.value},null,8,["disable"])]),_:1})]),_:1})]),_:1}),e(ge,null,{default:l(()=>[e(pe,null,{default:l(()=>[e(R,null,{default:l(()=>[e(y,{horizontal:"",class:"items-center"},{default:l(()=>[e(_,{header:""},{default:l(()=>{var i;return[n(d((i=m(g).order)==null?void 0:i.orderId),1)]}),_:1}),e(k),e(_,{header:""},{default:l(()=>{var i;return[n(d((i=m(g).order)==null?void 0:i.date),1)]}),_:1}),e(k),e(y,null,{default:l(()=>{var i,I;return[e(N,{color:"blue-5","text-color":"white",label:`Requester: ${(i=m(g).order)==null?void 0:i.requester}`},null,8,["label"]),e(N,{color:"blue-5","text-color":"white",label:`Recipient: ${(I=m(g).order)==null?void 0:I.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),h("div",Qe,[e(R,null,{default:l(()=>[e(y,null,{default:l(()=>[e(_,null,{default:l(()=>[n("Requester")]),_:1}),e(S,{modelValue:m(v).loggedUser.fullName,"onUpdate:modelValue":s[2]||(s[2]=i=>m(v).loggedUser.fullName=i),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(R,null,{default:l(()=>[e(y,null,{default:l(()=>[e(_,null,{default:l(()=>[n("Request to")]),_:1}),e(me,{modelValue:t.value.userRecipient,"onUpdate:modelValue":s[3]||(s[3]=i=>t.value.userRecipient=i),options:m(b).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:l(i=>[e(L,null,{default:l(()=>[e(w,{avatar:""},{default:l(()=>[e(M,{size:"sm","text-color":"white",style:se({backgroundColor:i.opt.color})},{default:l(()=>[n(d(i.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),e(w,null,{default:l(()=>[h("span",he,d(i.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),e(R,null,{default:l(()=>[e(y,null,{default:l(()=>[e(_,null,{default:l(()=>[n("Attachment")]),_:1}),e(fe,{modelValue:f.value,"onUpdate:modelValue":[s[4]||(s[4]=i=>f.value=i),o],label:"Select File",outlined:"",clearable:"",dense:""},{file:l(({file:i})=>[e(N,{size:"sm",color:"primary text-white"},{default:l(()=>[e(M,null,{default:l(()=>[e(oe,{name:"sym_o_description"})]),_:1}),h("div",Ie,d(i.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),e(R,null,{default:l(()=>[e(y,null,{default:l(()=>[e(_,null,{default:l(()=>[n("Request Message")]),_:1}),e(S,{modelValue:t.value.requestMessage,"onUpdate:modelValue":s[5]||(s[5]=i=>t.value.requestMessage=i),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(R,null,{default:l(()=>[e(qe)]),_:1})]),_:1})]),_:1})]),_:1}))}});var ze=Z(Pe,[["__scopeId","data-v-df320bdc"]]);export{ze as default};
