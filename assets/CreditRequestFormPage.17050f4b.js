import{Q as X}from"./QToolbarTitle.7e5ca1eb.js";import{Q as Y}from"./QToolbar.90f03879.js";import{Q as Z}from"./QHeader.5ecb4e9c.js";import{b,Q as _,a as y}from"./use-form.1ff89c0b.js";import{Q as F}from"./QSpace.fbb96cb9.js";import{Q as C}from"./QChip.77f3298f.js";import{Q as P}from"./QInput.830bcb78.js";import{k as D,h as L,o as A,i as ee,n as e,w as l,p as m,aQ as te,s as n,t as d,a5 as h,bg as S,_ as le,u as ae,a as re,g as ie,l as se,$ as ue,R as U,B as oe,H as w,m as ne,q as x,aU as de,a9 as ce,Q as O,bh as me,aR as V,bi as fe}from"./index.1bbbef81.js";import{b as k,a as M}from"./QList.86b5a361.js";import{Q as pe}from"./QSelect.2b83e9ad.js";import{Q as ve,a as T}from"./QFile.b1ad33e4.js";import{Q as ge}from"./QPage.eee2d5a7.js";import{Q as be,a as Re}from"./QLayout.c7b9c561.js";import{Q as _e}from"./QCheckbox.26289f04.js";import{c as ye,a as qe,b as p}from"./QTable.c9e418a8.js";import"./QSeparator.be43a22a.js";import"./use-fullscreen.b667f2ed.js";const Qe={class:"row"},he=D({__name:"OrderLinesCreditTable",setup(B){const v=L(),q=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,u=Number(c.cancellationFeePct)||0,Q=f*a*(1-u/100);return S(Q)},g=c=>{const f=Number(c.creditQty)>0?Number(c.creditQty):0,a=Number(c.unitPrice)||0,u=Number(c.cancellationFeePct)||0,Q=f*a*(u/100);return S(Q)},I=[{name:"recipient",label:"Recipient",align:"left",field:"recipient"},{name:"venueObs",label:"Venue",align:"left",field:"venueObs"},{name:"service",label:"Service",align:"left",field:"service"},{name:"quantity",label:"Quantity",align:"right",field:"quantity"},{name:"unitPrice",label:"Unit Price",align:"right",field:"unitPrice"},{name:"total",label:"Total",align:"right",field:"total"},{name:"creditQty",label:"Qty Credited",align:"right",field:"creditQty"},{name:"cancellationFeePct",label:"Fee",align:"right",field:"cancellationFeePct"},{name:"creditSubtotal",label:"To Credit",align:"right"}];return(c,f)=>(A(),ee("div",Qe,[e(ye,{rows:m(v).dataLines,columns:I,selected:m(v).selectedRows,"onUpdate:selected":f[0]||(f[0]=a=>m(v).selectedRows=a),"rows-per-page-options":[0],"row-key":"dataLineId",selection:"multiple","virtual-scroll":"","hide-pagination":"",dense:"",title:"Order Lines",class:"header-table",style:{height:"50vh",overflow:"auto",margin:"0.4rem"}},{body:l(a=>[e(qe,{props:a},{default:l(()=>[e(p,null,{default:l(()=>[e(_e,{modelValue:a.selected,"onUpdate:modelValue":u=>a.selected=u,color:"primary",onClick:te(u=>a.selected=!a.selected,["stop"])},null,8,["modelValue","onUpdate:modelValue","onClick"])]),_:2},1024),e(p,{key:"recipient",props:a},{default:l(()=>[n(d(a.row.recipient),1)]),_:2},1032,["props"]),e(p,{key:"venueObs",props:a},{default:l(()=>[e(k,null,{default:l(()=>[n(d(a.row.venueObs),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"service",props:a},{default:l(()=>[h("div",null,[e(C,{dense:"","text-color":"white",color:"cyan",label:a.row.service},null,8,["label"])]),h("div",null,d(a.row.description),1)]),_:2},1032,["props"]),e(p,{key:"quantity",props:a},{default:l(()=>[n(d(a.row.quantity),1)]),_:2},1032,["props"]),e(p,{key:"unitPrice",props:a},{default:l(()=>[n(d(m(S)(a.row.unitPrice)),1)]),_:2},1032,["props"]),e(p,{key:"total",props:a},{default:l(()=>[n(d(m(S)(a.row.total)),1)]),_:2},1032,["props"]),e(p,{key:"creditQty",props:a},{default:l(()=>[e(P,{modelValue:a.row.creditQty,"onUpdate:modelValue":u=>a.row.creditQty=u,modelModifiers:{number:!0},type:"number",dense:"","item-aligned":"","input-class":"text-right",rules:[u=>u<=a.row.quantity||"<= Qty"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1032,["props"]),e(p,{key:"cancellationFeePct",props:a},{default:l(()=>[e(P,{modelValue:a.row.cancellationFeePct,"onUpdate:modelValue":u=>a.row.cancellationFeePct=u,modelModifiers:{number:!0},type:"number",rules:[u=>u<=100],"item-aligned":"",dense:"","input-class":"text-right",suffix:"%",style:{"min-width":"4rem"},class:"q-pr-none"},null,8,["modelValue","onUpdate:modelValue","rules"]),e(b,{caption:""},{default:l(()=>[n(d(g(a.row)),1)]),_:2},1024)]),_:2},1032,["props"]),e(p,{key:"creditSubtotal",props:a},{default:l(()=>[n(d(q(a.row)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","selected"])]))}});const Ie={class:"row items-center"},Se={class:"text-h6"},Ce={class:"ellipsis"},Pe=D({__name:"CreditRequestFormPage",setup(B){const v=ae(),q=re(),g=ie(),I=L(),c=se();ue(()=>{v.readSettings(),q.readAllUsers();const i=c.query.orderId;typeof i=="string"&&g.readOrder(i)});const f=U(),a=U();async function u(i){a.value&&URL.revokeObjectURL(a.value),a.value=URL.createObjectURL(i);const s=await me(a.value);t.value.file&&f.value&&(t.value.file.base64=s,t.value.file.name=f.value.name)}const Q=oe(()=>!I.selectedRows.length||!t.value.userRecipient.userId),t=U({userRequester:{userId:"",fullName:"",groupId:"",notifications:[]},userRecipient:{userId:"",fullName:"",groupId:"",notifications:[]},orderId:"",date:"",customerRequester:"",customerRecipient:"",orderLines:[],requestMessage:"",file:{name:"",base64:""}});w(()=>q.userDeptHeads,i=>{i.length>0&&(t.value.userRecipient.userId=i[0].userId,t.value.userRecipient.fullName=i[0].fullName,t.value.userRecipient.groupId=i[0].groupId,t.value.userRecipient.notifications=i[0].notifications)},{immediate:!0}),w(()=>v.loggedUser,i=>{i&&(t.value.userRequester.userId=i.userId,t.value.userRequester.fullName=i.fullName,t.value.userRequester.groupId=i.groupId,t.value.userRequester.notifications=i.notifications)},{immediate:!0}),w(()=>g.order,i=>{Object.keys(i).length>0&&(t.value.orderId=i.orderId,t.value.date=i.date,t.value.customerRequester=i.requester,t.value.customerRecipient=i.recipient)},{immediate:!0});const $=()=>{V("ORD | Request Credit Services Actions",{Parameter:"Cancel Request"})},H=()=>{const i=fe();t.value.orderLines=I.selectedRows;const s=t.value.orderLines.length===1?"Service ":"Services ",r=t.value.orderLines.map(o=>o.service).join(", "),R=t.value.requestMessage?" Reason: "+t.value.requestMessage:"",j="Requested "+t.value.userRecipient.fullName+" to credit the following "+s+r+" from the Order "+t.value.orderId+R,z="Requested "+t.value.userRecipient.fullName+" to credit the following "+s+"<strong>"+r+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+R,E={timestampUnix:i,senderId:t.value.userRequester.userId||"",recipientId:t.value.userRecipient.userId||"",read:!1,status:"pending",type:"info",title:"Request Credit Services",requesterContent:z};t.value.userRequester.notifications||(t.value.userRequester.notifications=[]),t.value.userRequester.notifications.push(E);const G=t.value.userRequester.fullName+" has requested to credit the following "+s+"<strong>"+r+"</strong> from the Order <strong>"+t.value.orderId+"</strong> requested by <strong>"+t.value.customerRequester+"</strong> for <strong>"+t.value.customerRecipient+"</strong>"+R,J=t.value.orderLines.map(o=>(console.log("orderLine.cancellationFeeAmount",o.cancellationFeeAmount),{dataLineId:o.dataLineId,venue:o.venueObs,service:o.service,description:o.description,quantity:o.quantity,total:o.total,unitPrice:o.unitPrice,creditQty:o.creditQty,cancellationFeePct:o.cancellationFeePct,cancellationFeeAmount:o.creditQty*o.unitPrice*(o.cancellationFeePct/100)})),K={timestampUnix:i,senderId:t.value.userRequester.userId||"",recipientId:t.value.userRecipient.userId||"",read:!1,status:"pending",type:"task",title:"Request Credit Services",recipientContent:G,metadata:J};t.value.userRecipient.notifications||(t.value.userRecipient.notifications=[]),t.value.userRecipient.notifications.push(K);let N="";t.value.file&&t.value.file.base64&&(N=t.value.file.base64.replace(/^data:.*;base64,/,""));const W={...t.value,userRecipient:t.value.userRecipient,userRequester:t.value.userRequester,file:{...t.value.file,base64:N},activityDescription:j};V("ORD | Request Credit Services Actions",{Parameter:"Submit Request",Data:W})};return(i,s)=>(A(),ne(be,{view:"hHh lpR fFf"},{default:l(()=>[e(Z,null,{default:l(()=>[e(Y,{class:"bg-primary"},{default:l(()=>[e(X,null,{default:l(()=>[n(" Credit Request Form ")]),_:1})]),_:1})]),_:1}),e(Re,null,{default:l(()=>[e(ge,null,{default:l(()=>[e(_,null,{default:l(()=>[e(y,{horizontal:"",class:"items-center"},{default:l(()=>[e(b,{header:""},{default:l(()=>{var r;return[n(d((r=m(g).order)==null?void 0:r.orderId),1)]}),_:1}),e(F),e(b,{header:""},{default:l(()=>{var r;return[n(d((r=m(g).order)==null?void 0:r.date),1)]}),_:1}),e(F),e(y,null,{default:l(()=>{var r,R;return[e(C,{color:"blue-5","text-color":"white",label:`Requester: ${(r=m(g).order)==null?void 0:r.requester}`},null,8,["label"]),e(C,{color:"blue-5","text-color":"white",label:`Recipient: ${(R=m(g).order)==null?void 0:R.recipient}`},null,8,["label"])]}),_:1})]),_:1})]),_:1}),h("div",Ie,[e(_,null,{default:l(()=>[e(y,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Requester")]),_:1}),e(P,{modelValue:m(v).loggedUser.fullName,"onUpdate:modelValue":s[0]||(s[0]=r=>m(v).loggedUser.fullName=r),readonly:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(_,null,{default:l(()=>[e(y,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Request to")]),_:1}),e(pe,{modelValue:t.value.userRecipient,"onUpdate:modelValue":s[1]||(s[1]=r=>t.value.userRecipient=r),options:m(q).userDeptHeads,"option-value":"fullName","option-label":"fullName",dense:""},{option:l(r=>[e(M,null,{default:l(()=>[e(k,{avatar:""},{default:l(()=>[e(x,{size:"sm","text-color":"white",style:de({backgroundColor:r.opt.color})},{default:l(()=>[n(d(r.opt.initials),1)]),_:2},1032,["style"])]),_:2},1024),e(k,null,{default:l(()=>[h("span",Se,d(r.opt.fullName),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["modelValue","options"])]),_:1})]),_:1}),e(_,null,{default:l(()=>[e(y,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Attachment")]),_:1}),e(ve,{modelValue:f.value,"onUpdate:modelValue":[s[2]||(s[2]=r=>f.value=r),u],label:"Select File",outlined:"",clearable:"",dense:""},{file:l(({file:r})=>[e(C,{size:"sm",color:"primary text-white"},{default:l(()=>[e(x,null,{default:l(()=>[e(ce,{name:"sym_o_description"})]),_:1}),h("div",Ce,d(r.name),1)]),_:2},1024)]),_:1},8,["modelValue"])]),_:1})]),_:1})]),e(_,null,{default:l(()=>[e(y,null,{default:l(()=>[e(b,null,{default:l(()=>[n("Request Message")]),_:1}),e(P,{modelValue:t.value.requestMessage,"onUpdate:modelValue":s[3]||(s[3]=r=>t.value.requestMessage=r),label:"Request Message",outlined:"",dense:""},null,8,["modelValue"])]),_:1})]),_:1}),e(_,{style:{"min-height":"396px"}},{default:l(()=>[e(he)]),_:1})]),_:1})]),_:1}),e(T,{style:{"background-color":"var(--primary-white)"},class:"text-white"},{default:l(()=>[e(T,{style:{"background-color":"var(--primary-white)"},class:"text-white"},{default:l(()=>[e(M,null,{default:l(()=>[e(O,{color:"primary",type:"cancel",label:"Cancel",onClick:s[4]||(s[4]=r=>$())}),e(F),e(O,{color:"primary",type:"submit",label:"Submit Request",onClick:s[5]||(s[5]=r=>H()),disable:Q.value},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1}))}});var Ee=le(Pe,[["__scopeId","data-v-767efe8e"]]);export{Ee as default};
